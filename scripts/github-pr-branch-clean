#!/bin/bash
# github-pr-branch-clean.sh
#CHANGELOG:
# [0.0.3]
# - Added a dialog
# [April 3rd 2025]
# [0.0.2]
# - Increased limit to 50
# - set assignee to me
# [0.0.1]
# - initial version
# - Added `uniq` check to make sure we don't double delete branches

# requires see's if the utility is installed
requires() {
  if ! [ -x "$(command -v $1)" ]; then
    echo Error: "$1" is not installed. >&2
    if [ -n "$2" ]; then
      echo "Install with $2" >&2
      fi
    exit 1
  fi
}

requires git
requires jq
requires gh

RED=$(tput setaf 1)
GREEN="$(tput setaf 2)"
YELLOW="$(tput setaf 3)"
BLUE=$(tput setaf 4)
NC="$(tput sgr0)"
VERSION="v0.0.3"

limit=1000

# # Check if dialog is installed
# if command -v dialog &>/dev/null; then
#   use_dialog=true
# else
#   use_dialog=false
# fi

# # Check for --no-dialog argument
# if [[ "$1" == "--no-dialog" ]]; then
#   use_dialog=false
#   shift
# fi

# Parse args: support `--everyone` to include PRs from everyone
everyone=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    --everyone)
      everyone=true
      shift
      ;;
    *)
      break
      ;;
  esac
done

# If not using --everyone, limit to PRs authored by the current user
if [ "$everyone" = false ]; then
  author_arg=(--author "@me")
else
  author_arg=()
fi

# Fetch all merged PRs and their branch names
merged_prs=$(gh pr list --state merged --limit "$limit" "${author_arg[@]}" --json headRefName --jq '.[].headRefName' | uniq)

# Check if there are any merged PRs
if [ -z "$merged_prs" ]; then
    echo "No merged PRs found."
    exit 0
fi

# Count merged PRs (ignore empty lines)
count=$(echo "$merged_prs" | sed '/^\s*$/d' | wc -l | tr -d ' ')

# Print the count with red color
echo -e "Found ${RED}${count}${NC} merged PR(s)."

# If less than 20, display them. Otherwise ask the user if they want to list them.
if [ "$count" -lt 20 ]; then
  echo "Listing all merged PR branches:"
  echo "$merged_prs"
else
  read -r -p "Do you want to list the merged PR branches? (y/n): " list_choice
  if [[ "$list_choice" == "y" ]]; then
    echo "The following branches from merged PRs will be deleted:"
    echo "$merged_prs"
  fi
fi

# Ask for user confirmation to delete
read -r -p "Are you sure you want to delete these branches? (y/n): " confirm

if [[ "$confirm" != "y" ]]; then
    echo "Branch deletion canceled."
    exit 0
fi

# Loop through each branch name and delete it
for branch in $merged_prs; do
    echo "Deleting branch: $branch"
    git branch -d "$branch" 2>/dev/null || git branch -D "$branch"
done

echo "All merged PR branches have been deleted."